import dotenv from 'dotenv';                                                                                                    // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
import { resolve } from 'path';                                                                                                 // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
import { execSync } from 'child_process';                                                                                       // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
import { query } from '../../database/config.mjs';                                                                              // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

const isProduction = process.env.NODE_ENV === 'production';                                                                     // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã (–ø—Ä–æ–¥–∞–∫—à–µ–Ω –∏–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
const envPath = isProduction                                                                                                    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É .env –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    ? '/var/www/serpmonn.ru/backend/.env'                                                                                       // –ü—É—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
    : resolve(process.cwd(), 'backend/.env');                                                                                   // –ü—É—Ç—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

dotenv.config({ path: envPath });                                                                                               // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

import fetch from 'node-fetch';                                                                                                 // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
import Tokens from 'csrf';                                                                                                      // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CSRF-—Ç–æ–∫–µ–Ω–∞–º–∏

const csrf = new Tokens();                                                                                                      // –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CSRF

export const createMailbox = async (req, res) => {                                                                              // –≠–∫—Å–ø–æ—Ä—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞
    let emailLocalPart = null;                                                                                                  // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email
    
    try {                                                                                                                       // –ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        const { username, emailLocalPart: localPart, password } = req.body;                                                     // –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
        const userEmail = req.user.email;                                                                                       // –ü–æ–ª—É—á–µ–Ω–∏–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
        emailLocalPart = localPart;                                                                                             // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email

	// üîí –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û - CSRF –ø—Ä–æ–≤–µ—Ä–∫–∞
        /* –ü—Ä–æ–≤–µ—Ä–∫–∞ CSRF-—Ç–æ–∫–µ–Ω–∞
        const csrfToken = req.headers['x-csrf-token'];                                                                          // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
        if (!csrfToken || !csrf.verify(process.env.CSRF_SECRET || 'default-secret', csrfToken)) {                               // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ CSRF-—Ç–æ–∫–µ–Ω–∞
            return res.status(403).json({ message: '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π CSRF-—Ç–æ–∫–µ–Ω' });                                            // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ç–æ–∫–µ–Ω–µ
        }
	*/

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const [user] = await query('SELECT confirmed, mailbox_created FROM users WHERE email = ?', [userEmail]);                // –ó–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!user) {                                                                                                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return res.status(404).json({ message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });                                                 // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        }
        if (!user.confirmed) {                                                                                                  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return res.status(403).json({ message: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞' });             // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
        }
        if (user.mailbox_created) {                                                                                             // –ü—Ä–æ–≤–µ—Ä–∫–∞ÊòØÂê¶Â∑≤ÁªèÂàõÂª∫ËøáÈÇÆÁÆ±
            return res.status(403).json({ message: '–í—ã —É–∂–µ —Å–æ–∑–¥–∞–ª–∏ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫' });                                           // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É–∂–µ —Å–æ–∑–¥–∞–Ω
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if (!username || !emailLocalPart || !password) {                                                                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            return res.status(400).json({ message: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è' });                                    // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–ª–µ–π
        }
        if (!/^[a-z0-9._%+-]+$/.test(emailLocalPart)) {                                                                         // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email
            return res.status(400).json({ message: '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã ._%+-' });    // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        }
        if (password.length < 8) {                                                                                              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è
            return res.status(400).json({ message: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤' });                             // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∫–æ—Ä–æ—Ç–∫–æ–º –ø–∞—Ä–æ–ª–µ
        }

        const domain = 'onnmail.ru';                                                                                            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞ –¥–ª—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞
        const fullEmail = `${emailLocalPart}@${domain}`;                                                                        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ email –∞–¥—Ä–µ—Å–∞

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —è—â–∏–∫
        const mailboxExists = await checkMailboxExists(fullEmail);                                                              // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞
        if (mailboxExists) {                                                                                                    // –£—Å–ª–æ–≤–∏–µ –µ—Å–ª–∏ —è—â–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            return res.status(400).json({ message: '–ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });                                           // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —è—â–∏–∫–µ
        }

        console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞:', fullEmail);                                                        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞

        // 1. –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ virtual_mailbox (Postfix)
        console.log('üìù –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ virtual_mailbox...');                                                                // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        const virtualMailboxEntry = `${fullEmail} ${domain}/${emailLocalPart}/Maildir/\n`;                                      // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è virtual_mailbox
        execSync(`echo '${virtualMailboxEntry}' >> /etc/postfix/virtual_mailbox`);                                              // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª

        // 2. –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Postfix
        console.log('üîß –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Postfix...');                                                                   // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ë–î
        execSync('postmap /etc/postfix/virtual_mailbox');                                                                       // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ë–î Postfix

        // 3. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ—á—Ç—ã
        console.log('üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ—á—Ç—ã...');                                                                      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        const mailDir = `/var/vmail/${domain}/${emailLocalPart}/Maildir`;                                                       // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ—á—Ç—ã
        execSync(`mkdir -p ${mailDir}/{cur,new,tmp}`);                                                                          // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π Maildir
        execSync(`chown -R vmail:vmail /var/vmail/${domain}/${emailLocalPart}`);                                                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ vmail
        execSync(`chmod -R 700 /var/vmail/${domain}/${emailLocalPart}`);                                                        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

        // 4. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Dovecot passwd —Ñ–∞–π–ª
        console.log('üì® –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Dovecot...');                                                                  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const dovecotPassword = await generateDovecotPassword(password);                                                        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–µ—à–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è Dovecot
        const dovecotEntry = `${fullEmail}:${dovecotPassword}\n`;                                                               // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —Ñ–∞–π–ª–∞ –ø–∞—Ä–æ–ª–µ–π
        execSync(`echo '${dovecotEntry}' >> /var/mail/vusers/passwd`);                                                          // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª –ø–∞—Ä–æ–ª–µ–π Dovecot

        // 5. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª—É–∂–±—ã
        console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª—É–∂–±—ã...');                                                                              // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª—É–∂–±
        execSync('systemctl reload postfix');                                                                                   // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±—ã Postfix
        execSync('systemctl reload dovecot');                                                                                   // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±—ã Dovecot

        // 6. –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        console.log('üíæ –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...');                                                                      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
        await query('UPDATE users SET mailbox_created = ? WHERE email = ?', [1, userEmail]);                                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞ –≤ –ë–î

        console.log(`‚úÖ –ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ ${fullEmail} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`);                                                            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞

        res.status(201).json({                                                                                                  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
            success: true,                                                                                                      // –§–ª–∞–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            email: fullEmail,                                                                                                   // –°–æ–∑–¥–∞–Ω–Ω—ã–π email –∞–¥—Ä–µ—Å
            message: '–ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω'                                                                             // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        });

    } catch (error) {                                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –±–ª–æ–∫–µ try
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞:', error);                                                            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞
        
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        if (emailLocalPart) {                                                                                                   // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email –¥–ª—è –æ—Ç–∫–∞—Ç–∞
            try {                                                                                                               // –ë–ª–æ–∫ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                await rollbackMailboxCreation(emailLocalPart);                                                                  // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            } catch (rollbackError) {                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ:', rollbackError);                                                             // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç–∫–∞—Ç–∞
            }
        }

        res.status(400).json({                                                                                                  // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç—É
            message: error.message.includes('already exists') || error.message.includes('—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')                       // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏
                ? '–ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'                                                                                // –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —è—â–∏–∫–µ
                : '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞: ' + error.message                                                       // –û–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        });
    }
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞
async function checkMailboxExists(email) {                                                                                      // –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —è—â–∏–∫–∞
    try {                                                                                                                       // –ë–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ Postfix
        const postfixResult = execSync(`grep '^${email} ' /etc/postfix/virtual_mailbox 2>/dev/null || true`).toString().trim(); // –ü–æ–∏—Å–∫ email –≤ —Ñ–∞–π–ª–µ virtual_mailbox Postfix
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ Dovecot
        const dovecotResult = execSync(`grep '^${email}:' /var/mail/vusers/passwd 2>/dev/null || true`).toString().trim();      // –ü–æ–∏—Å–∫ email –≤ —Ñ–∞–π–ª–µ –ø–∞—Ä–æ–ª–µ–π Dovecot
        return postfixResult.length > 0 || dovecotResult.length > 0;                                                            // –í–æ–∑–≤—Ä–∞—Ç true –µ—Å–ª–∏ —è—â–∏–∫ –Ω–∞–π–¥–µ–Ω –≤ –æ–¥–Ω–æ–π –∏–∑ —Å–∏—Å—Ç–µ–º
    } catch (error) {                                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
        return false;                                                                                                           // –í–æ–∑–≤—Ä–∞—Ç false –ø—Ä–∏ –æ—à–∏–±–∫–µ
    }
}

// –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è
async function generateDovecotPassword(password) {                                                                              // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è Dovecot
    try {                                                                                                                       // –ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ try –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫
        const salt = execSync('openssl rand -base64 12')                                                                        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Å–æ–ª–∏ –¥–ª–∏–Ω–æ–π 12 –±–∞–π—Ç –≤ base64 —Ñ–æ—Ä–º–∞—Ç–µ
            .toString()                                                                                                         // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–∞ –≤—ã–≤–æ–¥–∞ –≤ —Å—Ç—Ä–æ–∫—É
            .trim()                                                                                                             // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
            .replace(/[^a-zA-Z0-9]/g, '')                                                                                       // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ-–∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ —Å–æ–ª–∏
            .substring(0, 16);                                                                                                  // –û–±—Ä–µ–∑–∫–∞ —Å–æ–ª–∏ –¥–æ 16 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        
        const hash = execSync(`openssl passwd -6 -salt ${salt} '${password}'`)                                                  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–µ—à–∞ SHA512 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Å–æ–ª–∏ –∏ –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            .toString()                                                                                                         // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫—É
            .trim();                                                                                                            // –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –≤–æ–∫—Ä—É–≥ —Ö–µ—à–∞
        
        console.log('üîê –•–µ—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');                                                                                     // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∞
        return `{SHA512-CRYPT}${hash}`;                                                                                         // –í–æ–∑–≤—Ä–∞—Ç —Ö–µ—à–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –¥–ª—è Dovecot
        
    } catch (error) {                                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Å–ª—É—á–∞–µ —Å–±–æ—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∞
        console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∞:', error);                                                                      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
        return `{PLAIN}${password}`;                                                                                            // –í–æ–∑–≤—Ä–∞—Ç –ø–∞—Ä–æ–ª—è –≤ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function rollbackMailboxCreation(emailLocalPart) {                                                                        // –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const domain = 'serpmonn.ru';                                                                                               // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞
    const fullEmail = `${emailLocalPart}@${domain}`;                                                                            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ email –∞–¥—Ä–µ—Å–∞
    
    try {                                                                                                                       // –ë–ª–æ–∫ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        console.log('üîÑ –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞...');                                                               // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ—Ç–∫–∞—Ç–∞
        
        // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ virtual_mailbox
        execSync(`sed -i '/^${fullEmail} /d' /etc/postfix/virtual_mailbox`);                                                    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ virtual_mailbox Postfix
        
        // –ü–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –±–∞–∑—É Postfix
        execSync('postmap /etc/postfix/virtual_mailbox');                                                                       // –ü–µ—Ä–µ–∫–æ–º–ø–∏–ª—è—Ü–∏—è –ë–î Postfix –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        
        // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ Dovecot passwd
        execSync(`sed -i '/^${fullEmail}:/d' /var/mail/vusers/passwd`);                                                         // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ñ–∞–π–ª–∞ –ø–∞—Ä–æ–ª–µ–π Dovecot
        
        // –£–¥–∞–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –ø–æ—á—Ç–æ–π
        const mailDir = `/var/vmail/${domain}/${emailLocalPart}`;                                                               // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ—á—Ç—ã
        execSync(`rm -rf ${mailDir}`);                                                                                          // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø–æ—á—Ç–æ–π
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª—É–∂–±—ã
        execSync('systemctl reload postfix');                                                                                   // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±—ã Postfix
        execSync('systemctl reload dovecot');                                                                                   // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±—ã Dovecot
        
        console.log('‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');                                                                               // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
    } catch (error) {                                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞:', error);                                                           // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç–∫–∞—Ç–∞
    }
}

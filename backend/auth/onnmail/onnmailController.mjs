import dotenv from 'dotenv';                                                                                                    // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
import { resolve } from 'path';                                                                                                 // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
import { execSync } from 'child_process';                                                                                       // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
import { query } from '../../database/config.mjs';                                                                              // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î Serpmonn (–≤–µ–±-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
import { mailQuery } from '../../database/mailDatabase.config.mjs';                                                             // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î mailserver (–ø–æ—á—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

const isProduction = process.env.NODE_ENV === 'production';                                                                     // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã (–ø—Ä–æ–¥–∞–∫—à–µ–Ω –∏–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
const envPath = isProduction                                                                                                    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É .env –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    ? '/var/www/serpmonn.ru/backend/.env'                                                                                       // –ü—É—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    : resolve(process.cwd(), 'backend/.env');                                                                                   // –ü—É—Ç—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å

dotenv.config({ path: envPath });                                                                                               // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

export const createMailbox = async (req, res) => {                                                                              // –≠–∫—Å–ø–æ—Ä—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞
    let emailLocalPart = null;                                                                                                  // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email –¥–ª—è –æ—Ç–∫–∞—Ç–∞
    
    try {                                                                                                                       // –ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        const { username, emailLocalPart: localPart, password } = req.body;                                                     // –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
        const userEmail = req.user.email;                                                                                       // –ü–æ–ª—É—á–µ–Ω–∏–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
        emailLocalPart = localPart;                                                                                             // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±–ª–æ–∫–µ catch

        console.log('üîç –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞ –¥–ª—è:', userEmail);                                                             // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞

        const [user] = await query('SELECT confirmed, mailbox_created FROM users WHERE email = ?', [userEmail]);                // –ó–∞–ø—Ä–æ—Å –∫ –ë–î Serpmonn –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        if (!user) {                                                                                                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤–µ–±-–ë–î
            return res.status(404).json({ message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });                                                 // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ 404 –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        }
        if (!user.confirmed) {                                                                                                  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return res.status(403).json({ message: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç' });                                                // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ 403 –µ—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
        }
        if (user.mailbox_created) {                                                                                             // –ü—Ä–æ–≤–µ—Ä–∫–∞ÊòØÂê¶Â∑≤ÁªèÂàõÂª∫ËøáÈÇÆÁÆ± (—Å–æ–∑–¥–∞–Ω –ª–∏ —É–∂–µ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫)
            return res.status(403).json({ message: '–í—ã —É–∂–µ —Å–æ–∑–¥–∞–ª–∏ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫' });                                           // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ 403 –µ—Å–ª–∏ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É–∂–µ —Å–æ–∑–¥–∞–Ω
        }

        if (!username || !localPart || !password) {                                                                             // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤ –∑–∞–ø—Ä–æ—Å–µ
            return res.status(400).json({ message: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è' });                                    // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ 400 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–ª–µ–π
        }
        if (!/^[a-z0-9._%+-]+$/.test(localPart)) {                                                                              // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, —Å–∏–º–≤–æ–ª—ã)
            return res.status(400).json({ message: '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã ._%+-' });    // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        }
        if (password.length < 8) {                                                                                              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è
            return res.status(400).json({ message: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤' });                             // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∫–æ—Ä–æ—Ç–∫–æ–º –ø–∞—Ä–æ–ª–µ
        }

        const domain = 'onnmail.ru';                                                                                            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞ –¥–ª—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞
        const fullEmail = `${localPart}@${domain}`;                                                                             // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ email –∞–¥—Ä–µ—Å–∞

        console.log('üì® –°–æ–∑–¥–∞–≤–∞–µ–º—ã–π email:', fullEmail);                                                                        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–≥–æ email –∞–¥—Ä–µ—Å–∞

        const existingMailUser = await mailQuery('SELECT id FROM users WHERE email = ?', [fullEmail]);                          // –ó–∞–ø—Ä–æ—Å –∫ –ë–î mailserver –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è email
        if (existingMailUser && existingMailUser.length > 0) {                                                                  // –ü—Ä–æ–≤–µ—Ä–∫–∞ÊòØÂê¶Â≠òÂú®ËÆ∞ÂΩï (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫)
            return res.status(400).json({ message: '–ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });                                           // –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ 400 –µ—Å–ª–∏ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        }

        const domainRows = await mailQuery('SELECT id FROM domains WHERE domain = ?', [domain]);                                // –ó–∞–ø—Ä–æ—Å –∫ –ë–î mailserver –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –¥–æ–º–µ–Ω–∞
        if (domainRows.length === 0) {                                                                                          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–æ–º–µ–Ω–∞ –≤ –ø–æ—á—Ç–æ–≤–æ–π –ë–î
            throw new Error(`–î–æ–º–µ–Ω ${domain} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î mailserver`);                                                       // –í—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –¥–æ–º–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω
        }
        const domainId = domainRows[0].id;                                                                                      // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –¥–æ–º–µ–Ω–∞ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞

        const dovecotPassword = await generateDovecotPassword(password);                                                        // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è –¥–ª—è Dovecot
        
        await mailQuery(                                                                                                        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î mailserver
            'INSERT INTO users (email, password, domain_id, home, uid, gid) VALUES (?, ?, ?, ?, ?, ?)',                         // SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ—á—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            [
                fullEmail,                                                                                                      // –ü–æ–ª–Ω—ã–π email –∞–¥—Ä–µ—Å
                dovecotPassword,                                                                                                // –•–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è Dovecot
                domainId,                                                                                                       // ID –¥–æ–º–µ–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã domains
                `/var/vmail/${domain}/${localPart}`,                                                                            // home - –ø—É—Ç—å –∫ –¥–æ–º–∞—à–Ω–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                5000,                                                                                                           // uid - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è vmail (–≤–ª–∞–¥–µ–ª–µ—Ü —Ñ–∞–π–ª–æ–≤)
                5000                                                                                                            // gid - ID –≥—Ä—É–ø–ø—ã vmail (–≥—Ä—É–ø–ø–∞ –¥–æ—Å—Ç—É–ø–∞)
            ]
        );

        const mailDir = `/var/vmail/${domain}/${localPart}/Maildir`;                                                            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Maildir
        try {                                                                                                                   // –ë–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
            execSync(`mkdir -p ${mailDir}/{cur,new,tmp}`);                                                                      // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π Maildir
            execSync(`chown -R vmail:vmail /var/vmail/${domain}/${localPart}`);                                                 // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –Ω–∞ vmail
            execSync(`chmod -R 700 /var/vmail/${domain}/${localPart}`);                                                         // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ 700
        } catch (fsError) {                                                                                                     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:', fsError);                                                           // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        }

        await query('UPDATE users SET mailbox_created = ? WHERE email = ?', [1, userEmail]);                                    // –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ mailbox_created –≤ –ë–î Serpmonn

        console.log(`üéâ –ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ ${fullEmail} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);                                                          // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞

        res.status(201).json({                                                                                                  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É —Å —Å—Ç–∞—Ç—É—Å–æ–º 201 (Created)
            success: true,                                                                                                      // –§–ª–∞–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
            email: fullEmail,                                                                                                   // –°–æ–∑–¥–∞–Ω–Ω—ã–π email –∞–¥—Ä–µ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            message: '–ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω'                                                                             // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ —è—â–∏–∫–∞
        });

    } catch (error) {                                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –±–ª–æ–∫–µ try
        console.error('üí• –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞:', error);                                                           // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞
        
        if (emailLocalPart) {                                                                                                   // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ email –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç–∞
            try {                                                                                                               // –ë–ª–æ–∫ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                await rollbackMailboxCreation(emailLocalPart);                                                                  // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            } catch (rollbackError) {                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—Ç–∫–∞—Ç–∞
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', rollbackError);                                                // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            }
        }

        let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞';                                                               // –ë–∞–∑–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (error.message.includes('Duplicate entry') || error.message.includes('—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')) {                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏ - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
            errorMessage = '–ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';                                                                      // –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ø–æ—á—Ç–æ–≤–æ–º —è—â–∏–∫–µ
        } else if (error.message.includes('ER_NO_SUCH_TABLE')) {                                                                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–∫–∏ - —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            errorMessage = '–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';                                                            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î
        } else if (error.message.includes('ER_ACCESS_DENIED_ERROR')) {                                                          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–∫–∏ - –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
            errorMessage = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';                                                                      // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
        } else {                                                                                                                // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
            errorMessage += ': ' + error.message;                                                                               // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        }

        res.status(400).json({                                                                                                  // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç—É —Å —Å—Ç–∞—Ç—É—Å–æ–º 400 (Bad Request)
            success: false,                                                                                                     // –§–ª–∞–≥ –Ω–µ—É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
            message: errorMessage                                                                                               // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        });
    }
};

async function generateDovecotPassword(password) {                                                                              // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
    try {                                                                                                                       // –ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ try –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫
        const salt = execSync('openssl rand -base64 12')                                                                        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Å–æ–ª–∏ –¥–ª–∏–Ω–æ–π 12 –±–∞–π—Ç –≤ base64 —Ñ–æ—Ä–º–∞—Ç–µ
            .toString()                                                                                                         // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–∞ –≤—ã–≤–æ–¥–∞ –≤ —Å—Ç—Ä–æ–∫—É
            .trim()                                                                                                             // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
            .replace(/[^a-zA-Z0-9]/g, '')                                                                                       // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ-–∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ —Å–æ–ª–∏
            .substring(0, 16);                                                                                                  // –û–±—Ä–µ–∑–∫–∞ —Å–æ–ª–∏ –¥–æ 16 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
        
        const hash = execSync(`openssl passwd -6 -salt ${salt} '${password}'`)                                                  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–µ—à–∞ SHA512 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Å–æ–ª–∏ –∏ –ø–∞—Ä–æ–ª—è
            .toString()                                                                                                         // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫—É
            .trim();                                                                                                            // –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –≤–æ–∫—Ä—É–≥ —Ö–µ—à–∞
        
        return `{SHA512-CRYPT}${hash}`;                                                                                         // –í–æ–∑–≤—Ä–∞—Ç —Ö–µ—à–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –¥–ª—è Dovecot
        
    } catch (error) {                                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Å–ª—É—á–∞–µ —Å–±–æ—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∞
        console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º PLAIN:', error);                                                    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
        return `{PLAIN}${password}`;                                                                                            // –í–æ–∑–≤—Ä–∞—Ç –ø–∞—Ä–æ–ª—è –≤ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
    }
}

async function rollbackMailboxCreation(emailLocalPart) {                                                                        // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const domain = 'onnmail.ru';                                                                                                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞ –¥–ª—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞
    const fullEmail = `${emailLocalPart}@${domain}`;                                                                            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ email –∞–¥—Ä–µ—Å–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏
    
    try {                                                                                                                       // –ë–ª–æ–∫ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        console.log('üîÑ –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è:', fullEmail);                                                                      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—Ç–∫–∞—Ç–∞
        
        await mailQuery('DELETE FROM users WHERE email = ?', [fullEmail]);                                                      // –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î mailserver
        
        const mailDir = `/var/vmail/${domain}/${emailLocalPart}`;                                                               // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ—á—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try {                                                                                                                   // –ë–ª–æ–∫ –ø–æ–ø—ã—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
            execSync(`rm -rf ${mailDir}`);                                                                                      // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        } catch (fsError) {                                                                                                     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:', fsError);                                                        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ—É–¥–∞—á–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏
        }
        
    } catch (error) {                                                                                                           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—Ç–∫–∞—Ç–∞
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);                                                                // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        throw error;                                                                                                            // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—ã—à–µ
    }
}

export default { createMailbox };                                                                                               // –≠–∫—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–∞ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π createMailbox –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
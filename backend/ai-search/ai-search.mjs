import dotenv from 'dotenv';
import express from 'express';                                                                  // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç Express –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
import cors from 'cors';                                                                        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç CORS –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–∂–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
import fetch from 'node-fetch';                                                                 // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç fetch –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Open WebUI
import rateLimit from 'express-rate-limit';                                                     // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
dotenv.config({ path: '/var/www/serpmonn.ru/backend/.env' });

const app = express();                                                                          // –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

// ============================================================================
// –ù–ê–°–¢–†–û–ô–ö–ò CORS - —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–æ–º–µ–Ω—ã
// ============================================================================
const corsOptions = {
    origin: [
        'https://serpmonn.ru',                                                                  // –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω
        'https://www.serpmonn.ru',                                                              // –î–æ–º–µ–Ω —Å www
        'http://localhost:3500',                                                                // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
        'http://127.0.0.1:3500'                                                                 // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å
    ],
    credentials: true,                                                                          // –†–∞–∑—Ä–µ—à–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É cookies
    methods: ['POST', 'OPTIONS'],                                                               // –¢–æ–ª—å–∫–æ POST –¥–ª—è –ø–æ–∏—Å–∫–∞
    allowedHeaders: ['Content-Type', 'Accept']                                                  // –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
};

app.use(cors(corsOptions));                                                                     // –ü—Ä–∏–º–µ–Ω—è–µ—Ç CORS –∫–æ –≤—Å–µ–º –º–∞—Ä—à—Ä—É—Ç–∞–º
app.use(express.json());                                                                        // –ü–∞—Ä—Å–∏–Ω–≥ JSON –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö

// ============================================================================
// –ó–ê–©–ò–¢–ê –û–¢ –ü–ï–†–ï–ì–†–£–ó–û–ö - –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
// ============================================================================
const aiSearchLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,                                                                   // 15 –º–∏–Ω—É—Ç
    max: 50,                                                                                    // 50 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP
    message: { error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' },                            // –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
    standardHeaders: true,                                                                      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ RateLimit
    legacyHeaders: false,                                                                       // –û—Ç–∫–ª—é—á–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    skipSuccessfulRequests: false,                                                              // –°—á–∏—Ç–∞–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
    keyGenerator: (req) => req.ip                                                               // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç IP –∫–∞–∫ –∫–ª—é—á
});

// ============================================================================
// –ú–ê–†–®–†–£–¢ –ò–ò-–ü–û–ò–°–ö–ê
// ============================================================================
app.post('/ai-search', aiSearchLimiter, async (req, res) => {
    try {
        console.log('üîç –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –ò–ò-–ø–æ–∏—Å–∫–∞ –æ—Ç IP:', req.ip);                              // –õ–æ–≥–∏—Ä—É–µ—Ç IP –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        
        const query = (req.body.q || '').trim();                                                // –ü–æ–ª—É—á–∞–µ—Ç –∏ –æ—á–∏—â–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        // ====================================================================
        // –í–ê–õ–ò–î–ê–¶–ò–Ø –ó–ê–ü–†–û–°–ê
        // ====================================================================
        if (!query) {                                                                           // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
            return res.status(400).json({ error: '–ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å' });                            // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 400
        }
        
        if (query.length < 2) {                                                                 // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å
            return res.status(400).json({ 
                error: '–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)' 
            });
        }
        
        if (query.length > 1000) {                                                              // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            return res.status(400).json({ 
                error: '–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–º–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤)' 
            });
        }
        
        console.log('üìù –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', query);                                          // –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        
        // ====================================================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø OPEN WEBUI
        // ====================================================================
        const apiKey = process.env.OPENWEBUI_API_KEY;                                           // –ö–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        const openWebUIUrl = process.env.OPENWEBUI_URL || 'http://127.0.0.1:8080';              // URL Open WebUI
        
        // ====================================================================
        // –ü–û–î–ì–û–¢–û–í–ö–ê –ó–ê–ü–†–û–°–ê –ö OPEN WEBUI
        // ====================================================================
        const payload = {
            model: process.env.AI_MODEL || 'serpmonn-ai-fast:latest',                           // –ú–æ–¥–µ–ª—å –∏–∑ .env –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            messages: [
                {
                    role: 'system',                                                             // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò)
                    content: `–¢—ã —É–º–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤–∏–∫ Serpmonn. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –∏—Å–ø–æ–ª—å–∑—É–π markdown.
                            –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç.
                            –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º. –û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –∑–∞–ø—Ä–æ—Å–∞.
                            –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç ‚Äî —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ.`
                },
                {
                    role: 'user',                                                               // –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    content: query
                }
            ],
            temperature: 0.3,                                                                   // –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–µ–Ω—å—à–µ = —Ç–æ—á–Ω–µ–µ)
            max_tokens: 2000,                                                                   // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞
            stream: false                                                                       // –ë–µ–∑ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
        };
        
        console.log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Open WebUI:', openWebUIUrl);                        // –õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞
        
        // ====================================================================
        // –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ö OPEN WEBUI
        // ====================================================================
        const controller = new AbortController();                                               // –°–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
        const timeoutId = setTimeout(() => controller.abort(), 30000);                          // –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥
        
        try {
            const response = await fetch(`${openWebUIUrl}/api/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,                                        // API –∫–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    'Content-Type': 'application/json',                                         // –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ JSON
                    'Accept': 'application/json'                                                // –û–∂–∏–¥–∞–µ—Ç JSON –≤ –æ—Ç–≤–µ—Ç–µ
                },
                body: JSON.stringify(payload),                                                  // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
                signal: controller.signal                                                       // –°–∏–≥–Ω–∞–ª –¥–ª—è –æ—Ç–º–µ–Ω—ã (—Ç–∞–π–º–∞—É—Ç)
            });
            
            clearTimeout(timeoutId);                                                            // –û—á–∏—â–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç
            
            if (!response.ok) {                                                                 // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å HTTP –æ—Ç–≤–µ—Ç–∞
                const errorText = await response.text();                                        // –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç Open WebUI:', response.status, errorText);          // –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
                
                let errorMessage = `–û—à–∏–±–∫–∞ Open WebUI (${response.status})`;                    // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                try {
                    const errorData = JSON.parse(errorText);                                    // –ü—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—à–∏–±–∫—É
                    if (errorData.error?.message) {
                        errorMessage = errorData.error.message;                                 // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—à–∏–±–∫–∏
                    }
                } catch (e) { /* –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON */ }
                
                return res.status(502).json({ error: errorMessage });                           // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É —à–ª—é–∑–∞
            }
            
            // ================================================================
            // –û–ë–†–ê–ë–û–¢–ö–ê –£–°–ü–ï–®–ù–û–ì–û –û–¢–í–ï–¢–ê
            // ================================================================
            const data = await response.json();                                                 // –ü–∞—Ä—Å–∏—Ç JSON –æ—Ç–≤–µ—Ç
            const aiAnswer = data.choices?.[0]?.message?.content;                               // –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            
            if (!aiAnswer) {                                                                    // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
                console.warn('‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Open WebUI:', data);                           // –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                return res.status(502).json({ error: '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò' });                   // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É
            }
            
            console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò, –¥–ª–∏–Ω–∞:', aiAnswer.length);                    // –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—Ö
            
            // ================================================================
            // –í–û–ó–í–†–ê–©–ê–ï–¢ –û–¢–í–ï–¢ –ö–õ–ò–ï–ù–¢–£
            // ================================================================
            res.json({ 
                answer: aiAnswer,                                                               // –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò
                model: data.model || 'unknown',                                                 // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
                usage: data.usage || null,                                                      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                timestamp: new Date().toISOString()                                             // –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞
            });
            
        } catch (fetchError) {
            clearTimeout(timeoutId);                                                            // –û—á–∏—â–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
            if (fetchError.name === 'AbortError') {                                             // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∞–π–º–∞—É—Ç
                console.error('‚è∞ –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ Open WebUI (30 —Å–µ–∫—É–Ω–¥)');                   // –õ–æ–≥–∏—Ä—É–µ—Ç —Ç–∞–π–º–∞—É—Ç
                return res.status(504).json({ error: '–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò' });                 // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É —Ç–∞–π–º–∞—É—Ç–∞
            }
            
            throw fetchError;                                                                   // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –¥–∞–ª—å—à–µ
        }
        
    } catch (error) {
        console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ /ai-search:', error);                            // –õ–æ–≥–∏—Ä—É–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É
        
        res.status(500).json({ 
            error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',                                                 // –û–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            details: process.env.NODE_ENV === 'development' ? error.message : undefined         // –î–µ—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
        });
    }
});

// ============================================================================
// –û–ë–†–ê–ë–û–¢–ö–ê –ù–ï–°–£–©–ï–°–¢–í–£–Æ–©–ò–• –ú–ê–†–®–†–£–¢–û–í
// ============================================================================
app.use('*', (req, res) => {
    res.status(404).json({ error: '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
});

// ============================================================================
// –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê
// ============================================================================
const PORT = process.env.AI_SEARCH_PORT || 3500;                                                // –ü–æ—Ä—Ç –∏–∑ .env –∏–ª–∏ 3500
app.listen(PORT, () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –ò–ò-–ø–æ–∏—Å–∫–∞ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);                                // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ
    console.log(`üîç –ü–æ–∏—Å–∫: POST http://localhost:${PORT}/ai-search`);                           // –°—Å—ã–ª–∫–∞ –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ–∏—Å–∫–∞
});
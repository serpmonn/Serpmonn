<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–∞–π–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–∞–π–∫–æ–≤</h1>
    
    <div class="test-section">
        <h3>1. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏</h3>
        <button onclick="showSessionInfo()">–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
        <div id="session-info" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. –ì–æ—Å—Ç–µ–≤–æ–π –ª–∞–π–∫</h3>
        <button onclick="testGuestLike()">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –≥–æ—Å—Ç–µ–≤–æ–π –ª–∞–π–∫</button>
        <div id="guest-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–∞–π–∫ (–º–∏–≥—Ä–∞—Ü–∏—è)</h3>
        <button onclick="testAuthLike()">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–∞–π–∫</button>
        <div id="auth-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</h3>
        <button onclick="checkStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
        <div id="status-result" class="result"></div>
    </div>

    <script>
        const TEST_URL = 'https://example.com/browser-test';
        
        function getOrCreateSessionId() {
            let sessionId = localStorage.getItem('likes_session_id');
            if (!sessionId) {
                sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('likes_session_id', sessionId);
            }
            return sessionId;
        }
        
        function showSessionInfo() {
            const result = document.getElementById('session-info');
            const sessionId = getOrCreateSessionId();
            const cookies = document.cookie;
            const hasToken = cookies.includes('token=');
            
            result.innerHTML = `
                <strong>Session ID:</strong> ${sessionId}<br>
                <strong>Cookies:</strong> ${cookies || '–ù–µ—Ç cookies'}<br>
                <strong>–ï—Å—Ç—å —Ç–æ–∫–µ–Ω:</strong> ${hasToken ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}
            `;
        }
        
        async function testGuestLike() {
            const result = document.getElementById('guest-result');
            result.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –ª–∞–π–∫–∞...';
            
            try {
                const sessionId = getOrCreateSessionId();
                const response = await fetch('/api/likes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `url=${encodeURIComponent(TEST_URL)}&session_id=${sessionId}`,
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                result.innerHTML = `
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}<br>
                    <strong>–û—Ç–≤–µ—Ç:</strong> <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                result.className = data.status === 'ok' ? 'result success' : 'result error';
            } catch (error) {
                result.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${error.message}`;
                result.className = 'result error';
            }
        }
        
        async function testAuthLike() {
            const result = document.getElementById('auth-result');
            result.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–∞–π–∫–∞...';
            
            try {
                const sessionId = getOrCreateSessionId();
                const response = await fetch('/api/likes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `url=${encodeURIComponent(TEST_URL)}&session_id=${sessionId}`,
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                let status = data.status === 'ok' ? 'success' : 'error';
                if (data.migrated) {
                    status = 'success';
                    result.innerHTML += '<br><strong>‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞!</strong>';
                }
                
                result.innerHTML = `
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}<br>
                    <strong>–û—Ç–≤–µ—Ç:</strong> <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                result.className = `result ${status}`;
            } catch (error) {
                result.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${error.message}`;
                result.className = 'result error';
            }
        }
        
        async function checkStatus() {
            const result = document.getElementById('status-result');
            result.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è...';
            
            try {
                const response = await fetch(`/api/likes?url=${encodeURIComponent(TEST_URL)}`);
                const data = await response.json();
                
                result.innerHTML = `
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}<br>
                    <strong>–û—Ç–≤–µ—Ç:</strong> <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${error.message}`;
                result.className = 'result error';
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = showSessionInfo;
    </script>
</body>
</html>
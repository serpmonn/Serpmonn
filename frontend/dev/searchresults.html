<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dev: Лайки поиска</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    .toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }
    .toolbar .status { font-weight: 600; }
    .toolbar input[type="text"] { padding: 6px 8px; font-size: 14px; }
    .toolbar button { padding: 6px 10px; cursor: pointer; }
    .panel { background: #f6f7f9; border: 1px solid #e1e5ea; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
    .panel h3 { margin: 0 0 8px 0; font-size: 14px; }
    .results { display: grid; gap: 14px; }
    .gsc-webResult.gsc-result { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; }
    .gs-title { font-size: 16px; margin: 0 0 6px 0; }
    .like-container { margin-top: 8px; }
    .like-badge { border: 1px solid #ddd; border-radius: 20px; padding: 4px 10px; background: #fff; }
    .like-badge.liked { background: #ffecef; border-color: #ffc2cb; }
    .like-badge .subcount { color: #0a7c2f; margin-left: 6px; font-size: 12px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; white-space: pre-wrap; background: #0b1020; color: #d6e1ff; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Dev: лайки результатов поиска</h1>

  <div class="panel toolbar">
    <span class="status">Пользователь: <span id="authUser">(гость)</span></span>
    <input id="userIdInput" type="text" placeholder="user-id (например, test-user-1)" />
    <button id="loginBtn" type="button">Войти</button>
    <button id="logoutBtn" type="button">Выйти</button>
  </div>

  <div class="panel">
    <h3>Миграция: перенести гостевой лайк → подтверждённый</h3>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="migrateUrl" type="text" placeholder="URL для миграции" style="flex:1; min-width: 320px;" />
      <button id="migrateBtn" type="button">Перенести</button>
    </div>
  </div>

  <div class="results" id="results">
    <!-- Небольшая фиктивная выборка результатов с ожидаемой разметкой CSE -->
    <div class="gsc-webResult gsc-result">
      <h2 class="gs-title"><a href="https://example.com/article-1?gclid=abc">Полезная статья №1</a></h2>
      <div class="gs-bidi-start-align">Описание результата 1</div>
    </div>
    <div class="gsc-webResult gsc-result">
      <h2 class="gs-title"><a href="https://example.org/post?id=42&fbclid=xyz">Пост в блоге №42</a></h2>
      <div class="gs-bidi-start-align">Описание результата 2</div>
    </div>
    <div class="gsc-webResult gsc-result">
      <h2 class="gs-title"><a href="https://serpmonn.com/help?q=dev">Справка Serpmonn</a></h2>
      <div class="gs-bidi-start-align">Описание результата 3</div>
    </div>
  </div>

  <h3>Журнал</h3>
  <div id="log" class="log"></div>

  <script>
    // Простая "фиктивная" авторизация для dev
    const authUserEl = document.getElementById('authUser');
    const userIdInput = document.getElementById('userIdInput');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const migrateBtn = document.getElementById('migrateBtn');
    const migrateUrl = document.getElementById('migrateUrl');
    const logEl = document.getElementById('log');

    function log(msg, obj) {
      const time = new Date().toLocaleTimeString();
      const text = `[${time}] ${msg}` + (obj ? `\n${JSON.stringify(obj, null, 2)}` : '');
      logEl.textContent = text + '\n' + logEl.textContent;
    }

    function refreshAuthUi() {
      const uid = (window.__spnAuthUserId || '').trim();
      authUserEl.textContent = uid ? uid : '(гость)';
    }

    loginBtn.addEventListener('click', () => {
      const uid = (userIdInput.value || '').trim();
      if (!uid) { alert('Укажите user-id'); return; }
      window.__spnAuthUserId = uid;
      refreshAuthUi();
      log('Вход выполнен', { user: uid });
    });

    logoutBtn.addEventListener('click', () => {
      window.__spnAuthUserId = '';
      refreshAuthUi();
      log('Выход выполнен');
    });

    migrateBtn.addEventListener('click', async () => {
      const uid = (window.__spnAuthUserId || '').trim();
      const url = (migrateUrl.value || '').trim();
      if (!uid) { alert('Сначала войдите (user-id)'); return; }
      if (!url) { alert('Укажите URL для миграции'); return; }
      try {
        const params = new URLSearchParams({ url, user: uid }).toString();
        const r = await fetch(`/dev/likes/migrate?${params}`, { method: 'POST', credentials: 'omit' });
        const j = await r.json().catch(() => ({}));
        log('Миграция выполнена', j);
      } catch (e) {
        log('Ошибка миграции', { error: String(e) });
      }
    });

    // Предзаполнить поле миграции URL из первого результата
    window.addEventListener('DOMContentLoaded', () => {
      const firstLink = document.querySelector('.gs-title a, a.gs-title');
      if (firstLink) migrateUrl.value = firstLink.href;
      refreshAuthUi();
    });
  </script>

  <script src="/frontend/scripts/search-likes-dev.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <title>Serpmonn Dev — Результаты поиска с лайками</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/frontend/images/serpmonn.ico" type="image/x-icon">
    <link rel="stylesheet" href="/frontend/styles/styles.css">
    <link rel="stylesheet" href="/frontend/styles/accessibility.css">
    <script>
      // Явная инициализация CSE (dev): гарантируем стабильный рендер бокса и результатов
      (function(){
        window.__gcse = { parsetags: 'explicit', callback: function() {
          try {
            google.search.cse.element.render({
              div: 'dev-searchbox',
              tag: 'searchbox-only',
              attributes: { resultsUrl: '/frontend/dev/searchresults.html', newWindow: false, gname: 'dev' }
            });
            google.search.cse.element.render({
              div: 'dev-searchresults',
              tag: 'searchresults-only',
              attributes: { gname: 'dev', linkTarget: '_self' }
            });
            // Если пришли с параметром в URL — выполняем запрос явно
            var sp = new URLSearchParams(location.search);
            var q = sp.get('gsc.q') || sp.get('q');
            if (q) {
              try { google.search.cse.element.getElement('dev').execute(q); } catch(e) {}
            }
          } catch (e) {}
        }};
        if (!document.querySelector('script[src*="cse.google.com/cse.js"]')) {
          var s=document.createElement('script');
          s.async=true; s.src='https://cse.google.com/cse.js?cx=97e62541ff5274a28';
          document.head.appendChild(s);
        }
      })();
    </script>
    <script type="module" src="/frontend/scripts/menu-loader.js" defer></script>
    <script type="module" src="/frontend/scripts/search-likes-dev.js" defer></script>
    <style>
      .like-badge { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#333; background:#f6f7f8; border:1px solid #e1e4e8; border-radius:999px; padding:4px 8px; cursor:pointer; user-select:none; }
      .like-badge.liked { color:#b30000; border-color:#f5c2c7; background:#fff5f5; }
      .like-badge .count { font-weight:600; }
      .gsc-webResult .like-container { margin-top:6px; }
      .dev-banner { background:#fff3cd; color:#664d03; padding:8px 12px; border:1px solid #ffecb5; border-radius:6px; margin:12px auto; max-width: 960px; }
      .container { max-width: 960px; margin: 0 auto; padding: 16px; }
      .logo { width: 65px; height: auto; vertical-align: middle; display: inline-block; }
    </style>
  </head>
  <body>
    <div class="dev-banner">Dev окружение • лайки пишутся в память на http://127.0.0.1:5100/dev/likes</div>
    <div class="container">
      <a href="/frontend/dev/main.html">На главную (Dev)</a>
    </div>
    <div class="container">
      <div class="main-search-container">
        <img src="/frontend/images/serpmonn.ico" alt="Serpmonn Logo" class="logo" title="Serpmonn">
        <div id="dev-searchbox"></div>
      </div>
    </div>
    <div class="container">
      <div id="dev-searchresults"></div>
    </div>
  </body>
  </html>


# 🚀 Быстрый старт: API Perfluence для промокодов (Безопасная архитектура)

## 🔒 Что исправлено

✅ **API ключ Perfluence** теперь хранится на сервере, а не на фронтенде  
✅ **Безопасная архитектура** - фронтенд обращается только к нашему API  
✅ **Автоматическое обновление** - промокоды обновляются каждые 30 минут  
✅ **Статистика в реальном времени** - количество активных/истекших промокодов  
✅ **Умная фильтрация** - поиск и категоризация по типу предложения  
✅ **Топ-офферы** - автоматическое выделение лучших предложений  
✅ **Уведомления** - статус обновления и обработка ошибок  

## 🏗️ Новая архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Фронтенд      │    │   Наш бэкенд     │    │  API Perfluence │
│   (Браузер)     │◄──►│   /api/promocodes│◄──►│  (Секретный     │
│                 │    │                  │    │   ключ)         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 📍 Где отображается статистика

Статистика отображается в **секции "Статистика и управление"** на странице промокодов:

- **Всего промокодов** - общее количество загруженных промокодов
- **Активных** - промокоды, которые еще не истекли
- **Истекших** - промокоды с истекшим сроком действия
- **Последнее обновление** - время последнего обновления данных

## 🚀 Как проверить

1. **Запустите бэкенд**: `npm start`
2. **Откройте страницу промокодов**: `/frontend/promo-codes-and-discounts/promokody-skidki.html`
3. **Проверьте статистику** - должны отображаться реальные цифры вместо "0"
4. **Нажмите "Обновить"** - для принудительного обновления данных
5. **Откройте консоль браузера** - для просмотра логов API

## 🧪 Тестирование API

Для проверки работы API используйте тестовую страницу:
`/frontend/promo-codes-and-discounts/test-api.html`

**Доступные тесты:**
- ✅ Подключение к API
- ✅ Загрузка промокодов
- ✅ Анализ структуры данных
- ✅ Тест фильтрации
- ✅ Просмотр статистики
- ✅ Принудительное обновление
- ✅ Получение категорий

## 🔧 API Endpoints

- **GET** `/api/promocodes` - получение всех промокодов
- **GET** `/api/promocodes/stats` - получение статистики
- **POST** `/api/promocodes/refresh` - принудительное обновление
- **GET** `/api/promocodes/categories` - получение категорий

## 📊 Структура ответа API

```json
{
    "status": "success",
    "data": [
        {
            "id": "abc123",
            "title": "Название промокода",
            "description": "Описание",
            "promocode": "КОД123",
            "discount_percent": 20,
            "category": "еда",
            "is_top": true,
            "valid_until": "2025-12-31T23:59:59Z"
        }
    ],
    "stats": {
        "total": 50,
        "active": 45,
        "expired": 5,
        "lastUpdate": "2025-01-19T12:00:00.000Z"
    }
}
```

## 🔍 Основные функции

- **`loadPromocodesFromAPI()`** - загрузка данных из нашего API
- **`refreshPromocodes()`** - принудительное обновление
- **`renderPromocodes()`** - отображение промокодов
- **`updateStats()`** - обновление статистики
- **`startAutoUpdate()`** - запуск автоматического обновления

## ⚠️ Возможные проблемы

❌ **API недоступен** - проверьте, запущен ли бэкенд  
❌ **Ошибка 500** - проверьте логи сервера  
❌ **CORS ошибка** - проверьте настройки CORS в бэкенде  
❌ **Пустые данные** - проверьте доступность API Perfluence  

## 🚀 Следующие шаги

- [ ] Протестировать на продакшене
- [ ] Настроить мониторинг ошибок
- [ ] Добавить fallback на локальные данные
- [ ] Реализовать WebSocket для real-time обновлений

## 📁 Файлы для проверки

- **Бэкенд**: `backend/promocodes/promocodesRoutes.mjs`
- **Фронтенд**: `frontend/promo-codes-and-discounts/promokody-skidki.js`
- **Сервер**: `backend/server.mjs` (строка с `/api/promocodes`)
- **Тесты**: `frontend/promo-codes-and-discounts/test-api.html`

---

**🎉 Готово к использованию! Безопасная архитектура реализована!**
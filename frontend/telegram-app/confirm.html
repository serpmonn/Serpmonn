<!DOCTYPE html>                                                                                             <!-- Объявление типа документа HTML5 -->
<html lang="ru">                                                                                            <!-- Открытие HTML документа с указанием языка - русский -->
<head>                                                                                                       <!-- Начало секции заголовка -->
    <meta charset="UTF-8">                                                                                  <!-- Установка кодировки UTF-8 для поддержки русских символов -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">                                  <!-- Настройка адаптивности для мобильных устройств -->
    <title>Подтверждение аккаунта - Serpmonn</title>                                                        <!-- Заголовок страницы в браузере -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>                                     <!-- Подключение Telegram Web App SDK -->
    <style>                                                                                                 
        * {                                                                                                  /* Универсальный селектор для всех элементов */
            margin: 0;                                                                                       /* Убираем внешние отступы */
            padding: 0;                                                                                      /* Убираем внутренние отступы */
            box-sizing: border-box;                                                                          /* Изменяем модель расчета размеров элементов */
        }
        
        body {                                                                                               /* Стили для тела документа */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;                  /* Установка системного шрифта */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);                                   /* Градиентный фон от синего к фиолетовому */
            min-height: 100vh;                                                                               /* Минимальная высота - весь экран */
            padding: 20px;                                                                                   /* Внутренние отступы по краям */
        }
        
        .container {                                                                                         /* Стили для основного контейнера */
            max-width: 400px;                                                                                /* Максимальная ширина контейнера */
            margin: 0 auto;                                                                                  /* Центрирование контейнера по горизонтали */
            background: white;                                                                               /* Белый фон контейнера */
            border-radius: 20px;                                                                             /* Закругленные углы */
            padding: 30px;                                                                                   /* Внутренние отступы */
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);                                                        /* Тень для эффекта глубины */
            text-align: center;                                                                              /* Выравнивание текста по центру */
        }
        
        .logo {                                                                                              /* Стили для логотипа */
            font-size: 48px;                                                                                 /* Размер эмодзи-логотипа */
            margin-bottom: 20px;                                                                             /* Отступ снизу */
        }
        
        h1 {                                                                                                 /* Стили для заголовка первого уровня */
            color: #333;                                                                                     /* Темно-серый цвет текста */
            margin-bottom: 10px;                                                                             /* Отступ снизу */
            font-size: 24px;                                                                                 /* Размер шрифта */
        }
        
        .description {                                                                                       /* Стили для описания */
            color: #666;                                                                                     /* Серый цвет текста */
            margin-bottom: 30px;                                                                             /* Отступ снизу */
            line-height: 1.5;                                                                                /* Межстрочный интервал */
        }
        
        .user-info {                                                                                         /* Стили для блока информации о пользователе */
            background: #f8f9fa;                                                                             /* Светло-серый фон */
            padding: 15px;                                                                                   /* Внутренние отступы */
            border-radius: 10px;                                                                             /* Закругленные углы */
            margin-bottom: 20px;                                                                             /* Отступ снизу */
            border-left: 4px solid #667eea;                                                                  /* Синяя полоса слева для акцента */
        }
        
        .user-id {                                                                                           /* Стили для отображения ID пользователя */
            font-family: 'Courier New', monospace;                                                           /* Моноширинный шрифт для технической информации */
            background: #e9ecef;                                                                             /* Светлый фон */
            padding: 5px 10px;                                                                               /* Внутренние отступы */
            border-radius: 5px;                                                                              /* Закругленные углы */
            font-size: 14px;                                                                                 /* Размер шрифта */
        }
        
        .confirm-btn {                                                                                       /* Стили для кнопки подтверждения */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);                                   /* Градиентный фон как у основного */
            color: white;                                                                                    /* Белый цвет текста */
            border: none;                                                                                    /* Без границы */
            padding: 15px 30px;                                                                              /* Внутренние отступы */
            border-radius: 10px;                                                                             /* Закругленные углы */
            font-size: 16px;                                                                                 /* Размер шрифта */
            font-weight: 600;                                                                                /* Жирное начертание */
            cursor: pointer;                                                                                 /* Указатель при наведении */
            width: 100%;                                                                                     /* Ширина на всю доступную область */
            transition: transform 0.2s;                                                                      /* Плавная анимация трансформации */
        }
        
        .confirm-btn:hover {                                                                                 /* Стили при наведении на кнопку */
            transform: translateY(-2px);                                                                     /* Легкое поднятие кнопки */
        }
        
        .confirm-btn:disabled {                                                                              /* Стили для отключенной кнопки */
            opacity: 0.6;                                                                                    /* Полупрозрачность */
            cursor: not-allowed;                                                                             /* Курсор "недоступно" */
            transform: none;                                                                                 /* Без трансформации */
        }
        
        .status {                                                                                            /* Стили для блока статуса */
            margin-top: 20px;                                                                                /* Отступ сверху */
            padding: 15px;                                                                                   /* Внутренние отступы */
            border-radius: 10px;                                                                             /* Закругленные углы */
            display: none;                                                                                   /* По умолчанию скрыт */
        }
        
        .status.success {                                                                                    /* Стили для успешного статуса */
            background: #d4edda;                                                                             /* Светло-зеленый фон */
            color: #155724;                                                                                  /* Темно-зеленый текст */
            border: 1px solid #c3e6cb;                                                                       /* Зеленая граница */
            display: block;                                                                                  /* Отображение блока */
        }
        
        .status.error {                                                                                      /* Стили для статуса ошибки */
            background: #f8d7da;                                                                             /* Светло-красный фон */
            color: #721c24;                                                                                  /* Темно-красный текст */
            border: 1px solid #f5c6cb;                                                                       /* Красная граница */
            display: block;                                                                                  /* Отображение блока */
        }
        
        .loading {                                                                                           /* Стили для индикатора загрузки */
            display: none;                                                                                   /* По умолчанию скрыт */
            margin-top: 20px;                                                                                /* Отступ сверху */
        }
        
        .spinner {                                                                                           /* Стили для анимированного спиннера */
            border: 4px solid #f3f3f3;                                                                       /* Светлая граница */
            border-top: 4px solid #667eea;                                                                   /* Синяя верхняя граница */
            border-radius: 50%;                                                                              /* Круглая форма */
            width: 40px;                                                                                     /* Ширина */
            height: 40px;                                                                                    /* Высота */
            animation: spin 1s linear infinite;                                                              /* Бесконечная анимация вращения */
            margin: 0 auto;                                                                                  /* Центрирование по горизонтали */
        }
        
        @keyframes spin {                                                                                    /* Определение анимации вращения */
            0% { transform: rotate(0deg); }                                                                  /* Начальное положение - 0 градусов */
            100% { transform: rotate(360deg); }                                                              /* Конечное положение - 360 градусов */
        }
    </style>                                                                                                 <!-- Конец блока CSS стилей -->
</head>                                                                                                      <!-- Конец секции заголовка -->
<body>                                                                                                       <!-- Начало тела документа -->
    <div class="container">                                                                                  <!-- Основной контейнер страницы -->
        <div class="logo">🤖</div>                                                                           <!-- Эмодзи-логотип бота -->
        <h1>Подтверждение аккаунта</h1>                                                                      <!-- Заголовок страницы -->
        <p class="description">Нажмите кнопку ниже чтобы подтвердить ваш аккаунт Serpmonn</p>                <!-- Описание назначения страницы -->
        
        <div class="user-info">                                                                              <!-- Блок информации о пользователе -->
            <strong>ID пользователя:</strong>                                                                <!-- Метка для ID пользователя -->
            <div class="user-id" id="userId">Загрузка...</div>                                               <!-- Контейнер для отображения ID пользователя -->
        </div>
        
        <button class="confirm-btn" id="confirmBtn">                                                         <!-- Кнопка подтверждения аккаунта -->
            ✅ Подтвердить аккаунт                                                                           <!-- Текст кнопки с эмодзи -->
        </button>
        
        <div class="loading" id="loading">                                                                   <!-- Контейнер индикатора загрузки -->
            <div class="spinner"></div>                                                                      <!-- Анимированный спиннер -->
            <p style="margin-top: 10px;">Подтверждаем...</p>                                                 <!-- Текст под спиннером -->
        </div>
        
        <div class="status" id="status"></div>                                                               <!-- Контейнер для отображения статуса операции -->
    </div>

    <script>                                                                                                 <!-- Начало блока JavaScript -->
        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;                                                                   // Получаем экземпляр Telegram Web App
        
        // Инициализация
        tg.expand();                                                                                         // Раскрываем Web App на весь экран
        tg.BackButton.show();                                                                                // Показываем кнопку "Назад" в интерфейсе Telegram
        tg.enableClosingConfirmation();                                                                      // Включаем подтверждение при закрытии (предотвращает случайное закрытие)
        
        // Элементы DOM
        const userIdElement = document.getElementById('userId');                                             // Получаем элемент для отображения ID пользователя
        const confirmBtn = document.getElementById('confirmBtn');                                            // Получаем кнопку подтверждения
        const loadingElement = document.getElementById('loading');                                           // Получаем элемент индикатора загрузки
        const statusElement = document.getElementById('status');                                             // Получаем элемент для отображения статуса

        // Получаем параметры
        function getUserId() {                                                                               // Функция для получения ID пользователя из различных источников
            // Способ 1: Из start_param (когда открыто через startapp)
            if (tg.initDataUnsafe?.start_param) {                                                            // Проверяем наличие start_param в данных Telegram
                return tg.initDataUnsafe.start_param;                                                        // Возвращаем ID из параметра запуска
            }
            
            // Способ 2: Из URL параметров
            const urlParams = new URLSearchParams(window.location.search);                                   // Создаем объект для работы с параметрами URL
            const startappParam = urlParams.get('startapp');                                                 // Получаем параметр startapp из URL
            if (startappParam) {                                                                             // Если параметр существует
                return startappParam;                                                                        // Возвращаем его значение
            }
            
            // Способ 3: Из hash
            const hashParams = new URLSearchParams(window.location.hash.substring(1));                       // Парсим hash часть URL (после #)
            return hashParams.get('startapp') || 'Не найден';                                                // Возвращаем параметр из hash или текст по умолчанию
        }

        // Показываем ID пользователя
        const userId = getUserId();                                                                          // Получаем ID пользователя
        userIdElement.textContent = userId;                                                                  // Отображаем ID в соответствующем элементе

        // Обработчик кнопки подтверждения
        confirmBtn.addEventListener('click', async () => {                                                   // Добавляем обработчик клика на кнопку подтверждения
            // Показываем загрузку
            confirmBtn.disabled = true;                                                                      // Отключаем кнопку для предотвращения повторных нажатий
            confirmBtn.textContent = 'Подтверждаем...';                                                      // Меняем текст кнопки
            loadingElement.style.display = 'block';                                                          // Показываем индикатор загрузки
            statusElement.style.display = 'none';                                                            // Скрываем блок статуса

            try {                                                                                            // Начало блока обработки ошибок
                console.log('Отправляем запрос подтверждения для userId:', userId);                          // Логируем отправку запроса
                
                const response = await fetch('/auth/confirm-telegram', {                                     // Отправляем POST запрос на сервер для подтверждения
                    method: 'POST',                                                                          // Метод запроса - POST
                    headers: {                                                                               // Заголовки запроса
                        'Content-Type': 'application/json',                                                  // Указываем тип содержимого - JSON
                    },
                    body: JSON.stringify({                                                                   // Тело запроса в формате JSON
                        userId: userId,                                                                      // ID пользователя для подтверждения
                        source: 'telegram_web_app'                                                           // Источник запроса - Telegram Web App
                    })
                });

                const result = await response.json();                                                        // Парсим ответ сервера в формате JSON
                console.log('Ответ сервера:', result);                                                       // Логируем ответ сервера

                // Скрываем загрузку
                loadingElement.style.display = 'none';                                                       // Скрываем индикатор загрузки

                if (result.success) {                                                                        // Если сервер вернул успешный результат
                    // Успешное подтверждение
                    statusElement.className = 'status success';                                              // Устанавливаем класс для успешного статуса
                    statusElement.innerHTML = `                                                              // Заполняем HTML содержимое блока статуса
                        <h3>✅ Аккаунт подтвержден!</h3>                                                      <!-- Заголовок успеха -->
                        <p>${result.message}</p>                                                             <!-- Сообщение от сервера -->
                        <p>Теперь вы можете войти на сайт.</p>                                               <!-- Дополнительная инструкция -->
                    `;
                    
                    confirmBtn.style.display = 'none';                                                       // Скрываем кнопку подтверждения
                    
                    // Обновляем кнопку "Назад"
                    tg.BackButton.offClick();                                                                // Удаляем предыдущие обработчики кнопки "Назад"
                    tg.BackButton.onClick(() => {                                                            // Устанавливаем новый обработчик для кнопки "Назад"
                        tg.close();                                                                          // Закрываем Web App при клике
                    });
                    
                    // Закрываем через 3 секунды
                    setTimeout(() => {                                                                       // Устанавливаем таймер
                        tg.close();                                                                          // Закрываем Web App через 3 секунды
                    }, 3000);
                    
                } else {                                                                                     // Если сервер вернул ошибку
                    // Ошибка
                    statusElement.className = 'status error';                                                // Устанавливаем класс для статуса ошибки
                    statusElement.innerHTML = `                                                              // Заполняем HTML содержимое блока статуса
                        <h3>❌ Ошибка подтверждения</h3>                                                      <!-- Заголовок ошибки -->
                        <p>${result.message}</p>                                                             <!-- Сообщение об ошибке от сервера -->
                    `;
                    
                    confirmBtn.disabled = false;                                                             // Включаем кнопку обратно
                    confirmBtn.textContent = '✅ Повторить попытку';                                          // Меняем текст кнопки
                }

            } catch (error) {                                                                                // Обработка ошибок сети или других исключений
                console.error('Ошибка сети:', error);                                                        // Логируем ошибку в консоль
                
                loadingElement.style.display = 'none';                                                       // Скрываем индикатор загрузки
                statusElement.className = 'status error';                                                    // Устанавливаем класс для статуса ошибки
                statusElement.innerHTML = `                                                                  // Заполняем HTML содержимое блока статуса
                    <h3>❌ Ошибка сети</h3>                                                                   <!-- Заголовок ошибки сети -->
                    <p>Проверьте подключение к интернету и попробуйте снова.</p>                             <!-- Сообщение для пользователя -->
                    <p>${error.message}</p>                                                                  <!-- Техническое сообщение об ошибке -->
                `;
                
                confirmBtn.disabled = false;                                                                 // Включаем кнопку обратно
                confirmBtn.textContent = '✅ Повторить попытку';                                              // Меняем текст кнопки
            }
        });

        // Обработчик кнопки "Назад"
        tg.BackButton.onClick(() => {                                                                        // Устанавливаем обработчик для кнопки "Назад" в Telegram
            if (confirmBtn.style.display !== 'none') {                                                       // Если кнопка подтверждения еще отображается (процесс не завершен)
                tg.showConfirm('Вы уверены что хотите выйти? Подтверждение не завершено.', (confirmed) => {  // Показываем диалог подтверждения выхода
                    if (confirmed) {                                                                         // Если пользователь подтвердил выход
                        tg.close();                                                                          // Закрываем Web App
                    }
                });
            } else {                                                                                         // Если процесс подтверждения завершен
                tg.close();                                                                                  // Закрываем Web App без подтверждения
            }
        });

        // Инициализация Theme
        function setTheme() {                                                                                // Функция для установки темы в зависимости от настроек Telegram
            if (tg.colorScheme === 'dark') {                                                                 // Если в Telegram установлена темная тема
                document.body.style.background = '#1e1e1e';                                                  // Устанавливаем темный фон для body
                document.querySelector('.container').style.background = '#2d2d2d';                           // Устанавливаем темный фон для контейнера
                document.querySelector('.container').style.color = '#ffffff';                                // Устанавливаем белый цвет текста
            }
        }
        
        tg.onEvent('themeChanged', setTheme);                                                                // Подписываемся на событие смены темы в Telegram
        setTheme();                                                                                          // Вызываем функцию установки темы при загрузке
    </script>                                                                                                <!-- Конец блока JavaScript -->
</body>                                                                                                      <!-- Конец тела документа -->
</html>                                                                                                      <!-- Конец HTML документа -->
# ============================================================================
# МАРШРУТЫ ДЛЯ СИСТЕМЫ ПЕРСОНАЛИЗАЦИИ SERPMONN
# ============================================================================

# Прокси для персонализированных новостей на порт 4000
location /api/news/personalized {
    proxy_pass http://localhost:4000/api/news/personalized;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 30s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
}

# Прокси для получения новостей из конкретного источника
location ~ ^/api/news/source/([^/]+)$ {
    proxy_pass http://localhost:4000/api/news/source/$1;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 30s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
}

# Прокси для получения новостей по категории
location ~ ^/api/news/category/([^/]+)$ {
    proxy_pass http://localhost:4000/api/news/category/$1;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 30s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
}

# Прокси для получения списка доступных источников
location /api/news/sources {
    proxy_pass http://localhost:4000/api/news/sources;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 30s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
}

# Прокси для получения статистики источников
location /api/news/stats {
    proxy_pass http://localhost:4000/api/news/stats;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 30s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
}

# Прокси для проверки доступности источника
location ~ ^/api/news/source/([^/]+)/check$ {
    proxy_pass http://localhost:4000/api/news/source/$1/check;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 30s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
}

# ============================================================================
# КОММЕНТАРИИ И ИНСТРУКЦИИ
# ============================================================================

# ЭТИ МАРШРУТЫ НУЖНО ДОБАВИТЬ В ВАШ ОСНОВНОЙ КОНФИГУРАЦИОННЫЙ ФАЙЛ NGINX
# В СЕКЦИЮ server { ... } ДЛЯ ДОМЕНА serpmonn.ru
#
# ВСЕ МАРШРУТЫ ПРОКСИРУЮТСЯ НА ПОРТ 4000, ГДЕ ДОЛЖЕН БЫТЬ ЗАПУЩЕН
# УЛУЧШЕННЫЙ СЕРВЕР НОВОСТЕЙ С ПОДДЕРЖКОЙ ПЕРСОНАЛИЗАЦИИ
#
# СУЩЕСТВУЮЩИЙ МАРШРУТ /news ОСТАЕТСЯ БЕЗ ИЗМЕНЕНИЙ ДЛЯ ОБРАТНОЙ СОВМЕСТИМОСТИ